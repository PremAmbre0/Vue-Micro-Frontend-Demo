name: Deploy All Apps

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Apps
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Clean previous builds
        run: |
          echo "ðŸ§¹ Cleaning previous builds and virtual packages..."
          npm run clean || echo "Clean script not available, continuing..."
          rm -rf node_modules/__mf__virtual || echo "No virtual packages to clean"
          rm -rf dist || echo "No dist directory to clean"
          echo "âœ… Cleanup completed"

      - name: Build All Apps
        run: |
          echo "ðŸš€ Building all micro frontends using Turbo..."
          echo "ðŸ“¦ Running: npm run build"
          npm run build
          echo ""
          echo "ðŸ“‹ Checking dist structure:"
          ls -la dist/ || echo "No dist directory found yet"
          echo ""
          echo "ðŸŽ‰ All apps built successfully!"
          echo ""
          echo "ï¿½ Expected structure:"
          echo "   dist/shell-app/"
          echo "   dist/demo-one-app/"
          echo "   dist/demo-two-app/"
          echo "   dist/demo-three-app/"
          echo "   dist/demo-counter-app/"

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Deploy to Vercel
        run: |
          echo "ðŸš€ Deploying to single Vercel project..."
          echo "ðŸ“ Deploying from dist directory with multiple app paths..."

          # Deploy the unified dist directory
          DEPLOYMENT_URL=$(vercel dist --prod --yes --token=$VERCEL_TOKEN)
          echo "âœ… Deployment completed!"
          echo "ðŸŒ Deployment URL: $DEPLOYMENT_URL"

          echo "ðŸ“ App URLs:"
          echo "   Shell App: $DEPLOYMENT_URL/shell-app"
          echo "   Demo One: $DEPLOYMENT_URL/demo-one-app"
          echo "   Demo Two: $DEPLOYMENT_URL/demo-two-app"
          echo "   Demo Three: $DEPLOYMENT_URL/demo-three-app"
          echo "   Demo Counter: $DEPLOYMENT_URL/demo-counter-app"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Create Summary
        run: |
          echo "## ðŸš€ Single Vercel Project Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Deployment URL: \$DEPLOYMENT_URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ App URLs:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… [Shell App](\$DEPLOYMENT_URL/shell-app)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… [Demo One App](\$DEPLOYMENT_URL/demo-one-app)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… [Demo Two App](\$DEPLOYMENT_URL/demo-two-app)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… [Demo Three App](\$DEPLOYMENT_URL/demo-three-app)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… [Demo Counter App](\$DEPLOYMENT_URL/demo-counter-app)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Structure:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "dist/" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ shell-app/          # Main shell application" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ demo-one-app/       # Basic shapes demo" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ demo-two-app/       # Text & images demo" >> $GITHUB_STEP_SUMMARY
          echo "â”œâ”€â”€ demo-three-app/     # Interactive canvas demo" >> $GITHUB_STEP_SUMMARY
          echo "â””â”€â”€ demo-counter-app/   # Counter with state sharing" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- Single Vercel project for all micro frontends" >> $GITHUB_STEP_SUMMARY
          echo "- Path-based routing (/shell-app, /demo-one-app, etc.)" >> $GITHUB_STEP_SUMMARY
          echo "- Unified deployment and management" >> $GITHUB_STEP_SUMMARY
          echo "- Cost-effective single project billing" >> $GITHUB_STEP_SUMMARY
          echo "- Turbo-powered build optimization" >> $GITHUB_STEP_SUMMARY
