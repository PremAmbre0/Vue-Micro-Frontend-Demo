name: Detect Changed Apps

on:
  push:
    branches:
      - main
      - master

jobs:
  detect-changes:
    name: Detect Changes with Turbo
    runs-on: ubuntu-latest
    environment: production
    outputs:
      shell: ${{ steps.detect.outputs.shell }}
      demo-one: ${{ steps.detect.outputs.demo-one }}
      demo-two: ${{ steps.detect.outputs.demo-two }}
      demo-three: ${{ steps.detect.outputs.demo-three }}
      demo-counter: ${{ steps.detect.outputs.demo-counter }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect changes using Turbo
        id: detect
        run: |
          echo "🔍 Detecting changes with Turbo..."
          
          # Use Turbo to detect changes
          CHANGED=$(npx turbo run build --filter='...[HEAD^1]' --dry=json | jq -r '.tasks[].package' | grep -v "vite-federation-workspace" || true)
          
          if [ -z "$CHANGED" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "shell=false" >> $GITHUB_OUTPUT
            echo "demo-one=false" >> $GITHUB_OUTPUT
            echo "demo-two=false" >> $GITHUB_OUTPUT
            echo "demo-three=false" >> $GITHUB_OUTPUT
            echo "demo-counter=false" >> $GITHUB_OUTPUT
          else
            echo "Changed packages detected:"
            echo "$CHANGED"
            
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Check each app
            if echo "$CHANGED" | grep -q "shell-app"; then
              echo "shell=true" >> $GITHUB_OUTPUT
              echo "✅ shell-app changed"
            else
              echo "shell=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED" | grep -q "demo-one-app"; then
              echo "demo-one=true" >> $GITHUB_OUTPUT
              echo "✅ demo-one-app changed"
            else
              echo "demo-one=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED" | grep -q "demo-two-app"; then
              echo "demo-two=true" >> $GITHUB_OUTPUT
              echo "✅ demo-two-app changed"
            else
              echo "demo-two=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$CHANGED" | grep -q "demo-three-app"; then
              echo "demo-three=true" >> $GITHUB_OUTPUT
              echo "✅ demo-three-app changed"
            else
              echo "demo-three=false" >> $GITHUB_OUTPUT
            fi

            if echo "$CHANGED" | grep -q "demo-counter-app"; then
              echo "demo-counter=true" >> $GITHUB_OUTPUT
              echo "✅ demo-counter-app changed"
            else
              echo "demo-counter=false" >> $GITHUB_OUTPUT
            fi
          fi



  summary:
    name: Change Detection Summary
    needs: [detect-changes]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        run: |
          echo "## 🔍 Change Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.has_changes }}" == "false" ]; then
            echo "### ✅ No changes detected" >> $GITHUB_STEP_SUMMARY
            echo "No apps need to be rebuilt" >> $GITHUB_STEP_SUMMARY
          else
            echo "### 📦 Apps that would be rebuilt:" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.detect-changes.outputs.shell }}" == "true" ]; then
              echo "- ✅ Shell App (changed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⏭️ Shell App (no changes)" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.detect-changes.outputs.demo-one }}" == "true" ]; then
              echo "- ✅ Demo One App (changed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⏭️ Demo One App (no changes)" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.detect-changes.outputs.demo-two }}" == "true" ]; then
              echo "- ✅ Demo Two App (changed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⏭️ Demo Two App (no changes)" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.detect-changes.outputs.demo-three }}" == "true" ]; then
              echo "- ✅ Demo Three App (changed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⏭️ Demo Three App (no changes)" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "${{ needs.detect-changes.outputs.demo-counter }}" == "true" ]; then
              echo "- ✅ Demo Counter App (changed)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ⏭️ Demo Counter App (no changes)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Note:" >> $GITHUB_STEP_SUMMARY
          echo "Deployment is currently disabled for testing change detection." >> $GITHUB_STEP_SUMMARY
          echo "Only change detection is running to verify which apps would be rebuilt." >> $GITHUB_STEP_SUMMARY